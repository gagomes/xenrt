<VirtualHost *:80>
    ServerAdmin webmaster@localhost

    DocumentRoot /var/www/
    RedirectMatch ^/$ /share/control/
    RedirectMatch ^/xenrt$ /xenrt/
    RedirectMatch ^/share/control$ /share/control/
    RedirectMatch ^/control$ /control/

    RewriteEngine On
    RewriteRule ^/debian-security/(.*) /apt/apt-cacher-cgi.pl/security.debian.org/$1
    RewriteRule ^/debian-amd64/(.*) /apt/apt-cacher-cgi.pl/amd64.debian.net/debian-amd64/$1
    RewriteRule ^/debian/(.*) /apt/apt-cacher-cgi.pl/ftp.us.debian.org/debian/$1
    RewriteRule ^/debian-backports/(.*) /apt/apt-cacher-cgi.pl/www.backports.org/debian/$1
    RewriteRule ^/XenServer/([^/]+)/debian/(.*) /apt/apt-cacher-cgi.pl/updates.xensource.com/XenServer/$1/debian/$2

    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE application/json


    <Directory />
        Options FollowSymLinks ExecCGI
        AllowOverride None
    </Directory>

    <Directory /var/www/>
        Options Indexes FollowSymLinks MultiViews ExecCGI
        AddHandler cgi-script .cgi
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>

    <Directory /var/www/apt/>
        Options Indexes FollowSymLinks MultiViews ExecCGI
        AddHandler cgi-script .pl
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>

    ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
    <Directory "/usr/lib/cgi-bin">
        AllowOverride None
        Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
        Order allow,deny
        Allow from all
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog ${APACHE_LOG_DIR}/access.log combined

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    ProxyRequests       Off
    ProxyPreserveHost   On
    ProxyPass           /xenrt http://localhost:1025/share/control retry=0
    ProxyPassReverse    /xenrt http://localhost:1025/share/control retry=0
    ProxyPass           /control http://localhost:1025/share/control retry=0
    ProxyPassReverse    /control http://localhost:1025/share/control retry=0
    ProxyPass           /share/control http://localhost:1025/share/control retry=0
    ProxyPassReverse    /share/control http://localhost:1025/share/control retry=0

    <Location /auth>
        AuthName @@KERBEROSREALM@@
        AuthType Kerberos
        Krb5Keytab /etc/xenrt/keytab
        KrbServiceName HTTP
        KrbAuthRealms @@KERBEROSREALM@@
        KrbMethodNegotiate on
        KrbMethodK5Passwd on
        KrbSaveCredentials off
        KrbVerifyKDC off
        Require Valid-User
    </Location>


    RequestHeader unset X-Forwarded-User
    RewriteEngine On
    RewriteCond %{LA-U:REMOTE_USER} (.+)
    RewriteRule .* - [E=RU:%1]
    RequestHeader add X-Forwarded-User %{RU}e
    RequestHeader unset Authorization

    ProxyPass           /auth http://localhost:1025/share/control retry=0
    ProxyPassReverse    /auth http://localhost:1025/share/control retry=0


</VirtualHost>
